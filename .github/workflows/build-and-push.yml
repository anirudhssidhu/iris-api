name: Build & Push (Artifact Registry)

on:
  push:
    branches: [ "main" ]
    paths:
      - "app/**"
      - "Dockerfile"
      - ".github/workflows/build-and-push.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID:   ${{ secrets.GCP_PROJECT_ID }}
      GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
      GAR_REPO:     ${{ secrets.GAR_REPO }}
      IMAGE_NAME:   ${{ secrets.IMAGE_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker $GAR_LOCATION-docker.pkg.dev --quiet

      - name: Build image
        run: |
          IMAGE_URI="$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME"
          GIT_SHA="${{ github.sha }}"
          docker build -t "$IMAGE_URI:$GIT_SHA" -t "$IMAGE_URI:latest" .

      - name: Push image
        run: |
          IMAGE_URI="$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME"
          GIT_SHA="${{ github.sha }}"
          docker push "$IMAGE_URI:$GIT_SHA"
          docker push "$IMAGE_URI:latest"
