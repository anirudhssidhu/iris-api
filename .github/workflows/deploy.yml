name: Deploy to GKE

on:
  push:
    branches: [ "main" ]
    paths:
      - "k8s/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID:     ${{ secrets.GCP_PROJECT_ID }}
      GKE_CLUSTER:    ${{ secrets.GKE_CLUSTER }}
      GKE_LOCATION:   ${{ secrets.GKE_LOCATION }}
      NAMESPACE:      ${{ secrets.K8S_NAMESPACE }}
      GAR_LOCATION:   ${{ secrets.GAR_LOCATION }}
      GAR_REPO:       ${{ secrets.GAR_REPO }}
      IMAGE_NAME:     ${{ secrets.IMAGE_NAME }}
    steps:
      - uses: actions/checkout@v4

      # ✅ Authenticate to Google Cloud (needed by get-gke-credentials and gcloud/kubectl)
      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # ✅ Ensure gcloud CLI (and GKE auth plugin) are present
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      # Get kubeconfig for your cluster
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_LOCATION }}
          project_id: ${{ env.PROJECT_ID }}

      # Create namespace if missing
      - name: Create namespace (idempotent)
        run: kubectl apply -f k8s/namespace.yaml

      # Create/refresh the Secret from your JSON key (so the pod can read GCS)
      - name: Create gcp-creds secret
        run: |
          echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > key.json
          kubectl -n "$NAMESPACE" delete secret gcp-creds --ignore-not-found=true
          kubectl -n "$NAMESPACE" create secret generic gcp-creds --from-file=key.json=key.json

      # Inject the image URI into the deployment
      - name: Inject image URI
        run: |
          IMAGE_URI="$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest"
          sed -i "s|REPLACE_WITH_ARTIFACT_REGISTRY_IMAGE|$IMAGE_URI|g" k8s/deployment.yaml

      # Apply manifests & wait for rollout
      - name: Apply manifests
        run: |
          kubectl -n "$NAMESPACE" apply -f k8s/deployment.yaml
          kubectl -n "$NAMESPACE" apply -f k8s/service.yaml

      - name: Wait for rollout
        run: kubectl -n "$NAMESPACE" rollout status deployment/iris-api --timeout=180s

      - name: Show service
        run: kubectl -n "$NAMESPACE" get svc iris-api -o wide
