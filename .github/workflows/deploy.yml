name: Deploy to GKE

on:
  push:
    branches: [ "main" ]
    paths:
      - "k8s/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID:     ${{ secrets.GCP_PROJECT_ID }}
      GKE_CLUSTER:    ${{ secrets.GKE_CLUSTER }}
      GKE_LOCATION:   ${{ secrets.GKE_LOCATION }}
      NAMESPACE:      ${{ secrets.K8S_NAMESPACE }}
      GAR_LOCATION:   ${{ secrets.GAR_LOCATION }}
      GAR_REPO:       ${{ secrets.GAR_REPO }}
      IMAGE_NAME:     ${{ secrets.IMAGE_NAME }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_CREDENTIALS_JSON }}
          export_default_credentials: true

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER" --region "$GKE_LOCATION" --project "$PROJECT_ID"

      - name: Create namespace (idempotent)
        run: kubectl apply -f k8s/namespace.yaml

      - name: Create gcp-creds secret
        run: |
          echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > key.json
          kubectl -n "$NAMESPACE" delete secret gcp-creds --ignore-not-found=true
          kubectl -n "$NAMESPACE" create secret generic gcp-creds --from-file=key.json=key.json

      - name: Inject image URI
        run: |
          IMAGE_URI="$GAR_LOCATION-docker.pkg.dev/$PROJECT_ID/$GAR_REPO/$IMAGE_NAME:latest"
          sed -i "s|REPLACE_WITH_ARTIFACT_REGISTRY_IMAGE|$IMAGE_URI|g" k8s/deployment.yaml

      - name: Apply manifests
        run: |
          kubectl -n "$NAMESPACE" apply -f k8s/deployment.yaml
          kubectl -n "$NAMESPACE" apply -f k8s/service.yaml

      - name: Wait for rollout
        run: kubectl -n "$NAMESPACE" rollout status deployment/iris-api --timeout=180s

      - name: Show service
        run: kubectl -n "$NAMESPACE" get svc iris-api -o wide
